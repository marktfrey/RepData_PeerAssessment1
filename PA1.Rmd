---
title: "Reproducible Research: Peer Assessment 1"
output:
  html_document:
    keep_md: true
---

Before beginning, we set the global options for the file.
```{r echo=TRUE}
library('knitr')
library('ggplot2')
library('grid')
library('gridExtra')
library('xtable')

opts_chunk$set(echo=TRUE, results="asis")
```




---

## Part I: Loading and preprocessing the data

Check for the `data` directory and create it if necessary.
```{r}
if (!file.exists("data")) {
  dir.create("data")
}
```
This directory is ignored by git, so that we don't commit both the zipped and unzipped data.


If the zipfile exists but hasn't been extracted, extract it.
```{r}
if (!file.exists("data/activity.csv")) {
  unzip("activity.zip", exdir="data", overwrite=FALSE)
}
```

Read in the data from the file.
```{r}
data <- read.csv("data/activity.csv")
```




---

## Part II: What is mean total number of steps taken per day?

> For this part of the assignment, you can ignore the missing values in the dataset.


> Make a histogram of the total number of steps taken each day

To prepare the histogram, we first need to aggregate the steps by date.

```{r}
daily_steps <- aggregate(steps ~ date, data = data, sum)
```

Note that aggregate throws out the days for which there is `NA` data - there are 61 unique days in the dataset, but only 53 of them have steps logged.

Then we can produce the histogram.  Setting the bin width to 500 gives a clearer picture of the distribution.

```{r steps_per_day_histogram}
ggplot(data = daily_steps, aes(daily_steps$steps)) +
       geom_histogram(binwidth = 500) +
       ggtitle('Days with Step Count') +
       xlab('Steps') +
       ylab('Days')
```


> Calculate and report the mean and median total number of steps taken per day

Using the aggreated data, we can calculate the mean (rounded to two decimal places)

```{r results='hide'}
steps_mean <- format(mean(daily_steps$steps), nsmall=2)
```

and the median

```{r results='hide'}
steps_median <- median(daily_steps$steps)
```

and report the figures.

The mean daily step count is __`r steps_mean`__ steps per day, and the median daily step count is __`r steps_median`__ steps per day.



---

## What is the average daily activity pattern?

> Make a time series plot (i.e. type = "l") of the 5-minute interval (x-axis) and the average number of steps taken, averaged across all days (y-axis)

To produce the time series plot, we first need to aggregate the data by interval.

```{r}
interval_mean <- aggregate(steps ~ interval, data = data, mean)
```

Then plot it as a line

```{r interval_mean_line}
ggplot(data = interval_mean, aes(y = interval_mean$steps,
                                 x = interval_mean$interval)
       ) +
      geom_line() +
      ggtitle('Mean Daily Steps/Interval') +
      xlab('Interval') +
      ylab('Mean Steps')
```

> Which 5-minute interval, on average across all the days in the dataset, contains the maximum number of steps?

We can identify the maximum interval and see that it matches with the observations from the graph

```{r, results = 'hide'}
max_interval <- interval_mean[interval_mean$steps == max(interval_mean$steps), ]
```

The maximum 5-minute interval is number __`r max_interval$interval`__, with an average step count of __`r max_interval$steps`__.



---

## Imputing missing values

> Calculate and report the total number of missing values in the dataset (i.e. the total number of rows with NAs)

We can easily determine this by examining the original data.

```{r}
na_count <- length(data$steps[is.na(data$steps)])
```

There are `r na_count` observations where there is no step data.


> Devise a strategy for filling in all of the missing values in the dataset. The strategy does not need to be sophisticated. For example, you could use the mean/median for that day, or the mean for that 5-minute interval, etc.

Let's take a look at each of these suggestions.  We can compose a set for each, and see which one looks like it describes the data best.

> Create a new dataset that is equal to the original dataset but with the missing data filled in.

The first two cases are relatively easy, we can just calculate the mean/median per interval and use it as a replacement for the na values.

```{r}
global_interval_mean <- mean(data$steps, na.rm = TRUE)
data$steps_gmean <- sapply(data$steps, function(x) {
  if (is.na(x))
    global_interval_mean
  else
    x 
  })
```

```{r}
global_interval_median <- median(data$steps, na.rm = TRUE)
data$steps_gmedian <- sapply(data$steps, function(x) {
  if (is.na(x))
    global_interval_median
  else
    x
  })
```


The third (where we use the interval mean) is slightly more complex, but still not too bad.

```{r}
data$steps_imean <- sapply(seq_along(data$steps), function(x, data) {
  if (is.na(data[x, "steps"]))
    interval_mean$steps[interval_mean$interval == data[x, "interval"]] 
  else
    data[x, "steps"]
  }, data = data)
```

This leaves us with data that looks like this when there are `NA` values:

```{r}
xt <- xtable(head(data[is.na(data$steps), ], 10))
print(xt, type = "html", html.table.attributes = "width=100% border=0")
```

> Make a histogram of the total number of steps taken each day and Calculate and report the mean and median total number of steps taken per day. Do these values differ from the estimates from the first part of the assignment? What is the impact of imputing missing data on the estimates of the total daily number of steps?

For the histograms, we'll need to produce the aggregate daily steps for the adjusted datasets.

```{r}
daily_steps_gmean <- aggregate(steps_gmean ~ date, data = data, sum)
daily_steps_gmedian <- aggregate(steps_gmedian ~ date, data = data, sum)
daily_steps_imean <- aggregate(steps_imean ~ date, data = data, sum)
```

Then we produce the plots and place them on a grid.  Note that we're pinning the y-axis using `coord_cartesian` to avoid autoscaling, so we get a clearer comparison.

```{r imputed_na_steps_per_day_histograms}
steps_plot <- ggplot(data = daily_steps, aes(daily_steps$steps)) +
                     geom_histogram(binwidth = 500) +
                     ggtitle('Not Imputed') +
                     xlab('Steps') +
                     ylab('# Days') +
                     coord_cartesian(ylim=c(0, 12)) +
                     theme(title = element_text(size=9),
                           axis.title = element_text(size=9))
gmean_plot <- ggplot(data = daily_steps_gmean, aes(daily_steps_gmean$steps)) +
                    geom_histogram(binwidth = 500) +
                    ggtitle('Imputed with Global Mean') +
                    xlab('Steps') +
                    ylab('# Days') +
                    coord_cartesian(ylim=c(0, 12)) +
                    theme(title = element_text(size=9),
                          axis.title = element_text(size=9))
gmedian_plot <- ggplot(data = daily_steps_gmedian, aes(daily_steps_gmedian$steps)) +
                       geom_histogram(binwidth = 500) +
                       ggtitle('Imputed with Global Median') +
                       xlab('Steps') +
                       ylab('# Days') +
                       coord_cartesian(ylim=c(0, 12)) +
                       theme(title = element_text(size=9),
                             axis.title = element_text(size=9))
imean_plot <- ggplot(data = daily_steps_imean, aes(daily_steps_imean$steps)) +
                     geom_histogram(binwidth = 500) +
                     ggtitle('Imputed with Interval Mean') +
                     xlab('Steps') +
                     ylab('# Days') +
                     coord_cartesian(ylim=c(0, 12)) +
                     theme(title = element_text(size=9),
                           axis.title = element_text(size=9))


grid.arrange(steps_plot, gmean_plot, gmedian_plot, imean_plot, ncol = 2)
```

We can see from observing the plots that all three methods of imputing the `NA` values add a lot more days to the histogram.  When using the global median, the majority of these end up with no steps (there must be a lot of intervals with no steps).  Both the global interval mean and the per-interval mean add more days in the middle of the histogram, which is more what might be expected.

If I were to choose one of the three methods, imputing using the daily mean for the specific interval for which data was missing would probably be the best model.



---

## Are there differences in activity patterns between weekdays and weekends?

> Create a new factor variable in the dataset with two levels – “weekday” and “weekend” indicating whether a given date is a weekday or weekend day.

```{r}
data$day_of_week <- weekdays(as.Date(strptime(data$date, '%Y-%m-%d')))
data$day_type <- as.factor(sapply(data$day_of_week, function(x){ if (is.element(x, c("Saturday", "Sunday"))){ "weekend" } else { "weekday" }}))
```

> Make a panel plot containing a time series plot (i.e. type = "l") of the 5-minute interval (x-axis) and the average number of steps taken, averaged across all weekday days or weekend days (y-axis). See the README file in the GitHub repository to see an example of what this plot should look like using simulated data.

```{r}
interval_means_with_day_type <- aggregate(steps ~ interval + day_type, data = data, mean)
```

Then plot the means as lines, faceting the plots by the day type.

```{r interval_mean_by_day_type_lines}
facetable_plot <- ggplot(data = interval_means_with_day_type,
                         aes(y = interval_means_with_day_type$steps,
                             x = interval_means_with_day_type$interval)
                        ) +
                        geom_line() +
                        ggtitle('Mean Daily Steps/Interval\nby day type') +
                        xlab('Interval') +
                        ylab('Mean Steps')

facetable_plot + facet_grid(. ~ day_type)
```

Observing the charts, we can see that on weekdays there is a more-active early-day period (perhaps this person walks or runs before going to work), and on weekends there seems to be more consistent activity throughout the day (whereas the activity in the weekdays seems to be broken up into chunks - maybe exercise, commute, lunch, break, commute.  This is purely speculative, but is a plausible explanation for the observed peaks/valleys in weekday activity).
